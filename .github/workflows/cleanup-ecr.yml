name: Cleanup Old ECR Images

on:
  schedule:
    # Ex√©cuter tous les dimanches √† 2h00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: todo-app
  KEEP_IMAGES: 3  # Nombre d'images √† conserver

jobs:
  cleanup-ecr:
    name: Cleanup ECR Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: List all images
        id: list-images
        run: |
          echo "üìã Listing all images in ECR repository..."
          aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --region ${{ env.AWS_REGION }} \
            --query 'sort_by(imageDetails,& imagePushedAt)[*].[imageDigest,imageTags[0],imagePushedAt]' \
            --output table

      - name: Delete old images
        run: |
          echo "üóëÔ∏è Deleting old images (keeping latest ${{ env.KEEP_IMAGES }})..."
          
          # R√©cup√©rer les digests des images √† supprimer (toutes sauf les X derni√®res)
          IMAGES_TO_DELETE=$(aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --region ${{ env.AWS_REGION }} \
            --query "reverse(sort_by(imageDetails,& imagePushedAt))[${{ env.KEEP_IMAGES }}:][imageDigest]" \
            --output text)
          
          if [ -z "$IMAGES_TO_DELETE" ]; then
            echo "‚úÖ No old images to delete"
            exit 0
          fi
          
          echo "Images to delete:"
          echo "$IMAGES_TO_DELETE"
          
          # Supprimer les images
          for digest in $IMAGES_TO_DELETE; do
            echo "Deleting image with digest: $digest"
            aws ecr batch-delete-image \
              --repository-name ${{ env.ECR_REPOSITORY }} \
              --region ${{ env.AWS_REGION }} \
              --image-ids imageDigest=$digest || true
          done
          
          echo "‚úÖ Cleanup completed"

      - name: Summary
        run: |
          echo "üìä Remaining images:"
          aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --region ${{ env.AWS_REGION }} \
            --query 'sort_by(imageDetails,& imagePushedAt)[*].[imageTags[0],imagePushedAt]' \
            --output table
