name: Setup AWS Load Balancer Controller

on:
  workflow_dispatch:  # ExÃ©cution manuelle uniquement

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: lab-cluster

jobs:
  install-alb-controller:
    name: Install AWS Load Balancer Controller
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.EKS_CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Cluster access configured"
          kubectl cluster-info
          kubectl get nodes

      - name: Install eksctl
        run: |
          echo "ğŸ“¦ Installing eksctl..."
          curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
          sudo mv /tmp/eksctl /usr/local/bin
          eksctl version

      - name: Create IAM Policy for Load Balancer Controller
        run: |
          echo "ğŸ“ Creating IAM policy..."
          
          # TÃ©lÃ©charger la policy
          curl -o iam-policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.7.0/docs/install/iam_policy.json
          
          # Obtenir l'Account ID
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "AWS Account ID: $AWS_ACCOUNT_ID"
          
          # CrÃ©er la policy (ignore si elle existe dÃ©jÃ )
          aws iam create-policy \
            --policy-name AWSLoadBalancerControllerIAMPolicy \
            --policy-document file://iam-policy.json \
            2>/dev/null || echo "âœ… Policy already exists"

      - name: Create IAM Service Account with IRSA
        run: |
          echo "ğŸ” Creating service account with IRSA..."
          
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          
          # CrÃ©er le service account avec IRSA
          eksctl create iamserviceaccount \
            --cluster=${{ env.EKS_CLUSTER_NAME }} \
            --namespace=kube-system \
            --name=aws-load-balancer-controller \
            --attach-policy-arn=arn:aws:iam::${AWS_ACCOUNT_ID}:policy/AWSLoadBalancerControllerIAMPolicy \
            --override-existing-serviceaccounts \
            --region=${{ env.AWS_REGION }} \
            --approve
          
          echo "âœ… Service account created"
          kubectl get sa aws-load-balancer-controller -n kube-system

      - name: Install Helm
        run: |
          echo "ğŸ“¦ Installing Helm..."
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Install AWS Load Balancer Controller
        run: |
          echo "ğŸš€ Installing AWS Load Balancer Controller..."
          
          # Ajouter le repo Helm
          helm repo add eks https://aws.github.io/eks-charts
          helm repo update
          
          # Installer le controller
          helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
            -n kube-system \
            --set clusterName=${{ env.EKS_CLUSTER_NAME }} \
            --set serviceAccount.create=false \
            --set serviceAccount.name=aws-load-balancer-controller \
            --set region=${{ env.AWS_REGION }} \
            --set vpcId=$(aws eks describe-cluster --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }} --query "cluster.resourcesVpcConfig.vpcId" --output text)
          
          echo ""
          echo "â³ Waiting for controller to be ready..."
          kubectl wait --for=condition=available --timeout=300s \
            deployment/aws-load-balancer-controller -n kube-system
          
          echo ""
          echo "âœ… AWS Load Balancer Controller installed successfully!"

      - name: Verify Installation
        run: |
          echo "ğŸ” Verifying installation..."
          echo ""
          
          echo "ğŸ“Š Deployment status:"
          kubectl get deployment -n kube-system aws-load-balancer-controller
          
          echo ""
          echo "ğŸ“¦ Pods:"
          kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller
          
          echo ""
          echo "ğŸ“ Controller logs (last 20 lines):"
          kubectl logs -n kube-system deployment/aws-load-balancer-controller --tail=20
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… SETUP COMPLETE!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "The AWS Load Balancer Controller is now installed and ready."
          echo "You can now deploy applications with Ingress resources."
          echo ""
          echo "Next step: Run the 'Build and Deploy' workflow to deploy your app."
